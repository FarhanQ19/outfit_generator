<!DOCTYPE html>
<html>
<head>
    <title>Outfit Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            width: 80%;
            margin: auto;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        header {
            background: #333;
            color: #fff;
            padding: 20px;
            text-align: center;
            width: 100%;
        }
        header h1 {
            text-transform: uppercase;
            margin: 0;
            font-size: 24px;
        }
        .filter-container {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .filter-container label {
            margin-right: 10px;
        }
        .select2-container--default .select2-selection--multiple {
            width: 200px; /* Adjust width as needed */
        }
        .select2-dropdown {
            width: 200px !important; /* Ensure the dropdown matches the select element width */
        }
        .outfit-display {
            position: relative;
            width: 400px;
            height: 600px;
            margin-bottom: 20px;
        }
        .outfit-display img {
            position: absolute;
            width: 150px;
            height: auto;
        }
        .hat { top: 0; left: calc(50% - 75px); }
        .bag { top: 150px; left: 0; }
        .accessory { top: 250px; left: 0; }
        .top { top: 150px; left: calc(50% - 75px); }
        .jacket { top: 150px; left: calc(100% - 100px); }
        .bottom { top: 300px; left: calc(50% - 75px); }
        .shoes { top: 525px; left: calc(50% - 75px); }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #333;
            color: #fff;
            border: none;
            cursor: pointer;
            margin-top: 20px;
        }
        .lock-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .lock-container label {
            display: flex;
            align-items: center;
        }
        .lock-container input[type="checkbox"] {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Outfit Generator</h1>
        <div class="nav-buttons">
            <a href="/">Back to Main Page</a>
            <a href="/saved_outfits">Saved Outfits</a>
        </div>
    </header>
    <div class="container">
        <div class="filter-container">
            <label for="season">Season:</label>
            <select id="season">
                <option value="any">Any</option>
                <option value="summer">Summer</option>
                <option value="winter">Winter</option>
                <option value="rain">Rain</option>
            </select>
            <label for="color">Color:</label>
            <select id="color" multiple="multiple">
                <option value="red">Red</option>
                <option value="blue">Blue</option>
                <option value="green">Green</option>
                <option value="yellow">Yellow</option>
                <option value="purple">Purple</option>
                <option value="orange">Orange</option>
                <option value="pink">Pink</option>
                <option value="brown">Brown</option>
                <option value="black">Black</option>
                <option value="white">White</option>
                <option value="gray">Gray</option>
                <option value="beige">Beige</option>
                <option value="navy">Navy</option>
            </select>
        </div>
        <div class="outfit-display" id="outfitDisplay">
            <!-- Images will be placed here by JavaScript -->
        </div>
        <button onclick="randomizeOutfit()">Randomize</button>
        <label><input type="checkbox" id="useColorGuide"> Use Color Guide</label>
        <button onclick="saveOutfit()">Save Outfit</button>
        <div class="lock-container">
            <label><input type="checkbox" id="lockHat">Lock Hat</label>
            <label><input type="checkbox" id="lockTop">Lock Top</label>
            <label><input type="checkbox" id="lockJacket">Lock Jacket</label>
            <label><input type="checkbox" id="lockBottom">Lock Bottom</label>
            <label><input type="checkbox" id="lockShoes">Lock Shoes</label>
            <label><input type="checkbox" id="lockBag">Lock Bag</label>
            <label><input type="checkbox" id="lockAccessory">Lock Accessory</label>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            $('#color').select2({
                placeholder: "Select colors",
                closeOnSelect: false,
                width: 'resolve'
            });
        });

        const outfits = [];
        let selectedOutfit = {};

        const colorGuide = {
            red: ['blue', 'dark blue', 'gray', 'white', 'black'],
            blue: ['red', 'pink', 'gray', 'white', 'black'],
            green: ['orange', 'purple', 'white', 'black'],
            yellow: ['green', 'gray', 'white', 'black'],
            purple: ['green', 'white', 'black'],
            orange: ['green', 'blue', 'white', 'black'],
            pink: ['blue', 'dark blue', 'gray', 'white', 'black'],
            brown: ['blue', 'gray', 'white', 'black'],
            black: ['any'],
            white: ['any'],
            gray: ['red', 'blue', 'pink', 'orange', 'purple', 'green', 'white', 'black'],
            beige: ['blue', 'green', 'brown', 'purple', 'white', 'black'],
            navy: ['blue', 'red', 'pink', 'yellow', 'white']
        };

        fetch('/outfits')
            .then(response => response.json())
            .then(data => {
                outfits.push(...data);
                console.log('Fetched outfits:', outfits);
                randomizeOutfit(); // Initial outfit display
            });

        let selectedTop = null;
        let selectedJacket = null;
        let selectedBottom = null;
        let selectedShoes = null;
        let selectedHat = null;
        let selectedBag = null;
        let selectedAccessory = null;

        function getSelectedValues(selectElement) {
            return $(selectElement).val();
        }

        function getRandomColors(baseColor) {
            const tonalColors = [baseColor];
            const guideColors = colorGuide[baseColor.toLowerCase()] || [];
            const complementaryColors = guideColors.filter(color => color !== 'any' && color !== 'black' && color !== 'white');
            return { tonalColors, complementaryColors };
        }

        function filterItems(items, category) {
            return items.filter(item => item.category === category);
        }

        function randomizeOutfit() {
            const outfitDisplay = document.getElementById('outfitDisplay');
            outfitDisplay.innerHTML = '';

            const season = document.getElementById('season').value;
            const colors = getSelectedValues('#color');
            const useColorGuide = document.getElementById('useColorGuide').checked;

            let filteredOutfits = outfits.filter(item =>
                (season === 'any' || item.season.toLowerCase() === season)
            );

            const matchedColors = new Set();
            if (useColorGuide) {
                const tonalOutfit = Math.random() < 0.5; // 50% chance to choose tonal or complementary colors

                if (colors.length > 0) {
                    colors.forEach(color => {
                        const { tonalColors, complementaryColors } = getRandomColors(color);
                        if (tonalOutfit) {
                            tonalColors.forEach(c => matchedColors.add(c));
                        } else {
                            complementaryColors.forEach(c => matchedColors.add(c));
                        }
                    });
                } else {
                    // If no colors are selected, randomly pick a base color and get its guide
                    const randomBaseColor = Object.keys(colorGuide)[Math.floor(Math.random() * Object.keys(colorGuide).length)];
                    const { tonalColors, complementaryColors } = getRandomColors(randomBaseColor);
                    if (tonalOutfit) {
                        tonalColors.forEach(c => matchedColors.add(c));
                    } else {
                        complementaryColors.forEach(c => matchedColors.add(c));
                    }
                }

                filteredOutfits = filteredOutfits.filter(item =>
                    matchedColors.has(item.color.toLowerCase()) ||
                    (item.secondary_color && matchedColors.has(item.secondary_color.toLowerCase())) ||
                    (item.tertiary_color && matchedColors.has(item.tertiary_color.toLowerCase())) ||
                    item.color.toLowerCase() === 'black' ||
                    item.color.toLowerCase() === 'white'
                );
            } else if (colors.length > 0) {
                filteredOutfits = filteredOutfits.filter(item =>
                    colors.includes(item.color.toLowerCase()) ||
                    (item.secondary_color && colors.includes(item.secondary_color.toLowerCase())) ||
                    (item.tertiary_color && colors.includes(item.tertiary_color.toLowerCase()))
                );
            }

            const tops = filterItems(filteredOutfits, 1);
            const bottoms = filterItems(filteredOutfits, 2);
            const shoes = filterItems(filteredOutfits, 3);
            const hats = filterItems(filteredOutfits, 4);
            const bags = filterItems(filteredOutfits, 5);
            const accessories = filterItems(filteredOutfits, 6);
            const jackets = filterItems(filteredOutfits, 7);

            console.log('Filtered tops:', tops);
            console.log('Filtered bottoms:', bottoms);
            console.log('Filtered shoes:', shoes);
            console.log('Filtered hats:', hats);
            console.log('Filtered bags:', bags);
            console.log('Filtered accessories:', accessories);
            console.log('Filtered jackets:', jackets);

            if (tops.length === 0 || bottoms.length === 0 || shoes.length === 0) {
                alert("Unable to generate outfit with current filters. Please adjust filters or add more items.");
                return;
            }

            if (!document.getElementById('lockTop').checked) {
                selectedTop = tops[Math.floor(Math.random() * tops.length)];
            }
            if (!document.getElementById('lockBottom').checked) {
                selectedBottom = bottoms[Math.floor(Math.random() * bottoms.length)];
            }
            if (!document.getElementById('lockShoes').checked) {
                selectedShoes = shoes[Math.floor(Math.random() * shoes.length)];
            }

            selectedOutfit = {
                hat_id: null,
                top_id: selectedTop ? selectedTop.id : null,
                jacket_id: null,
                bottom_id: selectedBottom ? selectedBottom.id : null,
                shoes_id: selectedShoes ? selectedShoes.id : null,
                bag_id: null,
                accessory_id: null
            };

            if (selectedTop) {
                const topImg = document.createElement('img');
                topImg.src = selectedTop.image_url;
                topImg.alt = selectedTop.name;
                topImg.className = 'top';
                outfitDisplay.appendChild(topImg);
            }

            if (selectedBottom) {
                const bottomImg = document.createElement('img');
                bottomImg.src = selectedBottom.image_url;
                bottomImg.alt = selectedBottom.name;
                bottomImg.className = 'bottom';
                outfitDisplay.appendChild(bottomImg);
            }

            if (selectedShoes) {
                const shoesImg = document.createElement('img');
                shoesImg.src = selectedShoes.image_url;
                shoesImg.alt = selectedShoes.name;
                shoesImg.className = 'shoes';
                outfitDisplay.appendChild(shoesImg);
            }

            // Optionally include non-essential items
            if (hats.length > 0 && (!document.getElementById('lockHat').checked)) {
                selectedHat = hats[Math.floor(Math.random() * hats.length)];
                if (selectedHat) {
                    const hatImg = document.createElement('img');
                    hatImg.src = selectedHat.image_url;
                    hatImg.alt = selectedHat.name;
                    hatImg.className = 'hat';
                    outfitDisplay.appendChild(hatImg);
                    selectedOutfit.hat_id = selectedHat.id;
                }
            }

            if (bags.length > 0 && (!document.getElementById('lockBag').checked)) {
                selectedBag = bags[Math.floor(Math.random() * bags.length)];
                if (selectedBag) {
                    const bagImg = document.createElement('img');
                    bagImg.src = selectedBag.image_url;
                    bagImg.alt = selectedBag.name;
                    bagImg.className = 'bag';
                    outfitDisplay.appendChild(bagImg);
                    selectedOutfit.bag_id = selectedBag.id;
                }
            }

            if (accessories.length > 0 && (!document.getElementById('lockAccessory').checked)) {
                selectedAccessory = accessories[Math.floor(Math.random() * accessories.length)];
                if (selectedAccessory) {
                    const accessoryImg = document.createElement('img');
                    accessoryImg.src = selectedAccessory.image_url;
                    accessoryImg.alt = selectedAccessory.name;
                    accessoryImg.className = 'accessory';
                    outfitDisplay.appendChild(accessoryImg);
                    selectedOutfit.accessory_id = selectedAccessory.id;
                }
            }

            if (jackets.length > 0 && (!document.getElementById('lockJacket').checked)) {
                selectedJacket = jackets[Math.floor(Math.random() * jackets.length)];
                if (selectedJacket) {
                    const jacketImg = document.createElement('img');
                    jacketImg.src = selectedJacket.image_url;
                    jacketImg.alt = selectedJacket.name;
                    jacketImg.className = 'jacket';
                    outfitDisplay.appendChild(jacketImg);
                    selectedOutfit.jacket_id = selectedJacket.id;
                }
            }
        }

        function saveOutfit() {
            fetch('/save_outfit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(selectedOutfit)
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'Outfit saved successfully') {
                    alert('Outfit saved successfully!');
                } else {
                    alert('Failed to save outfit.');
                }
            });
        }
    </script>
</body>
</html>
